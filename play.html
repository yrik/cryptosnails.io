<head>
<title>Crypto Snails - Earn $snail crypto by playing the game</title>

<link rel="icon" 
      type="image/png" 
      href="https://cryptosnails.io/snail-icon.png">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://npmcdn.com/moralis@0.0.6/dist/moralis.js"></script>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>

</style>

</head>

<body>

<div class="flex text-right hidden" id="logout-screen">
  <button class="p-2 mr-2" onClick="logout()">logout</button>
</div>

<div class="flex text-right hidden" id="login-screen">
  <button class="p-2 mr-2" onClick="login()">login with metamask</button>
</div>

<div style="height: calc(100% - 60px);" id="phaser" onClick="if(!Moralis.User.current()){login()}"><div>

<script>
  // connect to Moralis server
  Moralis.initialize("JBfxbweoLK5be7xnZineX05Z3MRAPBoIohXvvqgX");
  Moralis.serverURL = "https://vqntw2bxdpp2.bigmoralis.com:2053/server";
  Moralis.Web3.getSigningData = () => 'Sign in to CryptoSnails.io'

  const PlayerPosition = Moralis.Object.extend("PlayerPosition");

  async function start() {
    const user = Moralis.User.current();
    if (user) {
      $("#logout-screen").show()
    }
    else {
      $("#login-screen").show()
    }
    await launch()
  }
  async function logout(){
    await Moralis.User.logOut();
    location.reload()
  }

  async function login(){
    user = await Moralis.Web3.authenticate();
    if (user) {
      location.reload()
      /*
      await $("#login-screen").hide()
      $("#logout-screen").show()
      await launch()
      */
    }
  }

  const config = {
      type: Phaser.AUTO,
      //pixelArt: true,
      scale: {
          mode: Phaser.Scale.FIT,
          parent: 'phaser',
          autoCenter: Phaser.Scale.CENTER_BOTH,
          width: 800,
          height: 600
      },
       physics: {
          default: 'arcade',
          arcade: {
              //gravity: { y: 300 },
              debug: false
          }
      },
      scene: {
          preload: preload,
          create: create,
          update: update
      }
  };

  let player;
  let cursors;
  const competitors = {};

  async function preload () {
      this.load.image("player", "./basic-snail.svg");
      this.load.image("tiles", "./sprite.png");
  }

  async function create () {

    const size = 25
    const indexes = [...Array(size).keys()]

    let user = Moralis.User.current();

    const backgroundTileMap = this.make.tilemap({ 
      data: indexes.map( _ => indexes.map( _ => 4)), 
      tileWidth: 32, tileHeight: 32, tileMargin: 0, tileSpacing: 0, 
    })
    const backgroundTileSet = backgroundTileMap.addTilesetImage("tiles")
    const backgroundLayer = backgroundTileMap.createLayer(0, backgroundTileSet, 0, 0); // layer index, tileset, x, y

    const wallsTileMap= this.make.tilemap({ 
      data: indexes.map( row => indexes.map( col => {
        if (row % 4 == Math.floor(Math.random() * 2) && col % Math.floor(Math.random() * 5) == 0) return 8
      })),
      tileWidth: 32, tileHeight: 32, tileMargin: 0, tileSpacing: 0, 
    })
    const wallsTileSet = wallsTileMap.addTilesetImage("tiles")
    const wallsLayer = wallsTileMap.createLayer(0, wallsTileSet, 0, 0); // layer index, tileset, x, y
    wallsLayer.setCollisionBetween(1, 50);


    const edgeTileMap = this.make.tilemap({ 
      data: indexes.map( row => indexes.map( col => {
       if(row == 0 || row == size-1 || col == 0 || col == size-1) return 3 
      })), 
      tileWidth: 32, tileHeight: 32, tileMargin: 0, tileSpacing: 0, 
    })
    const edgeTileSet = edgeTileMap.addTilesetImage("tiles")
    const edgeLayer = edgeTileMap.createLayer(0, edgeTileSet, 0, 0); // layer index, tileset, x, y
    edgeLayer.setCollisionBetween(1, 50);


    // Phaser supports multiple cameras, but you can access the default camera like this:
    const camera = this.cameras.main;

    // Set up the arrows to control the camera
    cursors = this.input.keyboard.createCursorKeys();

    // Constrain the camera so that it isn't allowed to move outside the width/height of tilemap
    camera.setBounds(0, 0, backgroundTileMap.widthInPixels, backgroundTileMap.heightInPixels);

    // Help text that has a "fixed" position on the screen
    this.add
      .text(16, 16, "Arrow keys to move", {
        font: "12px monospace",
        fill: "#ffffff",
        padding: { x: 10, y: 5 },
        backgroundColor: "#000000"
      })
      .setScrollFactor(0);

    if (user) {
      let lastQuery = new Moralis.Query('PlayerPosition')
      lastQuery.equalTo("player", user.get("ethAddress"))
      const lastPosition = await lastQuery.descending("createdAt").first()
      let lastX = 300
      let lastY = 300
      if (lastPosition && lastPosition.get('x') && lastPosition.get('y')) {
        lastX = lastPosition.get('x')
        lastY = lastPosition.get('y')
      }

      player = this.physics.add.image(lastX, lastY, 'player').setScale(0.25).refreshBody();

      this.physics.add.collider(player, wallsLayer);
      this.physics.add.collider(player, edgeLayer);
      camera.startFollow(player)

      let query = new Moralis.Query('PlayerPosition');
      let subscription = await query.subscribe();

      subscription.on('create', (position) => {
        let x = position.get("x")
        let y = position.get("y")
        let addr = position.get("player")
        let currentUserAddr = user ? user.get("ethAddress") : undefined;

        // move competitors
        if(addr != currentUserAddr){
          // if first time seeing
          if(competitors[addr] == undefined){
            competitors[addr] = this.add.image(x, y, 'player').setScale(0.20);
          }
          else{
            competitors[addr].x = x;
            competitors[addr].y = y;
          }
        }
      });
    }

  }


  async function update(time, delta) {
    // Apply the controls to the camera each update tick of the game
    //controls.update(delta);


    if (cursors.left.isDown)
    {
        player.setVelocityX(-160);
        player.setFlip(false, false)
    }
    else if (cursors.right.isDown)
    {
        player.setVelocityX(160);
        player.setFlip(true, false)
    }
    else if (cursors.down.isDown)
    {
        player.setVelocityY(160);
    }
    else if (cursors.up.isDown)
    {
        player.setVelocityY(-160);
    }

    if(player.lastX!=player.x  || player.lastY!=player.y){
      let user = Moralis.User.current();
      
      if (user) {
        const playerPosition = new PlayerPosition();

        playerPosition.set("player",user.get("ethAddress"));
        playerPosition.set("x",player.x);
        playerPosition.set("y",player.y)

        player.lastX = player.x;
        player.lastY = player.y;

        await playerPosition.save();
      }
    }

  }

  async function launch() {
    const game = new Phaser.Game(config);
  }

  start()

</script>


</body>
