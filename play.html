<head>
<title>Crypto Snails - Earn $snail crypto by playing the game</title>

<link rel="icon" 
      type="image/png" 
      href="https://cryptosnails.io/snail-icon.png">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://npmcdn.com/moralis@0.0.6/dist/moralis.js"></script>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>

</style>

</head>

<body>

<div class="flex text-right hidden" id="logout-screen">
  <button class="p-2 mr-2" onClick="logout()">logout</button>
</div>

<div class="flex h-screen hidden" id="login-screen">
  <div class="m-auto">
    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4
      rounded" onClick="login()">login with metamask</button>
  </div>
</div>

<div style="height: calc(100% - 60px);" id="phaser"><div>

<script>
  // connect to Moralis server
  Moralis.initialize("JBfxbweoLK5be7xnZineX05Z3MRAPBoIohXvvqgX");
  Moralis.serverURL = "https://vqntw2bxdpp2.bigmoralis.com:2053/server";
  Moralis.Web3.getSigningData = () => 'Sign in to CryptoSnails.io'

  async function start() {
    let user = Moralis.User.current();
    if (user) {
      // start game
      $("#logout-screen").show()
      await launch(user)
    }
    else {
      // show auth window
      $("#login-screen").removeClass('hidden').addClass('flex')
    }

  }
  async function logout(){
    await Moralis.User.logOut();
    location.reload()
  }

  async function login(){
    user = await Moralis.Web3.authenticate();
    if (user) {
      await $("#login-screen").hide()
      $("#logout-screen").show()
      await launch(user)
    }
  }

  const config = {
      type: Phaser.AUTO,
      pixelArt: true,
      scale: {
          mode: Phaser.Scale.FIT,
          parent: 'phaser',
          autoCenter: Phaser.Scale.CENTER_BOTH,
          width: 800,
          height: 600
      },
      scene: {
          preload: preload,
          create: create,
          update: update
      }
  };

  async function preload () {
      this.load.image("tiles", "https://mikewesthad.github.io/phaser-3-tilemap-blog-posts/post-1/assets/tilesets/catastrophi_tiles_16_blue.png");
  this.load.tilemapCSV("map", "https://mikewesthad.github.io/phaser-3-tilemap-blog-posts/post-1/assets/tilemaps/catastrophi_level3.csv");
  }
  async function create () {
     // When loading a CSV map, make sure to specify the tileWidth and tileHeight!
  const map = this.make.tilemap({ key: "map", tileWidth: 16, tileHeight: 16 });
  const tileset = map.addTilesetImage("tiles");
  const layer = map.createLayer(0, tileset, 0, 0); // layer index, tileset, x, y

  // Phaser supports multiple cameras, but you can access the default camera like this:
  const camera = this.cameras.main;

  // Set up the arrows to control the camera
  const cursors = this.input.keyboard.createCursorKeys();
  controls = new Phaser.Cameras.Controls.FixedKeyControl({
    camera: camera,
    left: cursors.left,
    right: cursors.right,
    up: cursors.up,
    down: cursors.down,
    speed: 0.5
  });

  // Constrain the camera so that it isn't allowed to move outside the width/height of tilemap
  camera.setBounds(0, 0, map.widthInPixels, map.heightInPixels);

  // Help text that has a "fixed" position on the screen
  this.add
    .text(16, 16, "Arrow keys to scroll", {
      font: "18px monospace",
      fill: "#ffffff",
      padding: { x: 20, y: 10 },
      backgroundColor: "#000000"
    })
    .setScrollFactor(0);
  }
  async function update(time, delta) {
    // Apply the controls to the camera each update tick of the game
    controls.update(delta);
  }

  async function launch(user) {
    const game = new Phaser.Game(config);
  }

  start()

</script>


</body>
